<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Album Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: #d1d5db;
            min-height: 100vh;
        }
        .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }
        .glass-panel {
            background: rgba(31, 41, 55, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transition: left 0.5s ease;
        }
        .btn-primary:hover::before {
            left: 100%;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .btn-primary:disabled {
            background: #374151;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .vinyl-spin {
            animation: spin 3s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="max-w-6xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="font-orbitron text-4xl sm:text-5xl font-bold text-white tracking-wider mb-4">
                MEMORY ALBUM CREATOR
            </h1>
            <p class="text-purple-300 text-lg">Transform One Song Into A Personal Journey</p>
        </header>

        <main class="space-y-8">
            <section id="input-panel" class="glass-panel p-6 sm:p-8 space-y-6">
                <div>
                    <h2 class="text-xl font-bold text-white mb-4 flex items-center"><span class="text-2xl mr-2">[1]</span> Step 1: Upload Your Song</h2>
                    <div id="file-drop-zone" class="border-2 border-dashed border-gray-600 p-8 text-center rounded-lg cursor-pointer transition hover:border-purple-500 hover:bg-purple-500/10">
                        <input type="file" id="audio-file-input" class="hidden" accept="audio/*">
                        <svg class="mx-auto h-12 w-12 text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path></svg>
                        <p id="file-label" class="text-gray-400">Drop your audio file here, or click to browse</p>
                    </div>
                </div>
                <div>
                    <h2 class="text-xl font-bold text-white mb-4 flex items-center"><span class="text-2xl mr-2">[2]</span> Step 2: Personalize Your Album</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Album Title</label>
                            <input type="text" id="album-title" class="w-full bg-gray-900/50 border border-gray-600 rounded-lg p-3 focus:ring-2 focus:ring-purple-500" placeholder="e.g., Summer of '24">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Recipient Name</label>
                            <input type="text" id="recipient-name" class="w-full bg-gray-900/50 border border-gray-600 rounded-lg p-3 focus:ring-2 focus:ring-purple-500" placeholder="e.g., For Alex">
                        </div>
                    </div>
                </div>
                <div>
                    <h2 class="text-xl font-bold text-white mb-4 flex items-center"><span class="text-2xl mr-2">[3]</span> Step 3: Describe Your Memory Experiences</h2>
                    <div id="experience-inputs" class="space-y-3"></div>
                    <button id="add-experience" class="text-purple-400 hover:text-purple-300 transition flex items-center gap-2 mt-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        Add another experience
                    </button>
                </div>
                <button id="create-album-button" class="w-full btn-primary text-white font-bold py-4 px-6 rounded-lg text-lg" disabled>Create Memory Album</button>
            </section>

            <section id="processing-panel" class="glass-panel p-6 sm:p-8 text-center hidden">
                 <div class="mb-6">
                    <div class="vinyl-spin text-6xl mb-4">(O)</div>
                    <h2 id="processing-header" class="font-orbitron text-2xl font-bold text-white mb-2">Processing Your Album</h2>
                    <p id="processing-status" class="text-purple-300">Your album is being created in the background. This may take a few minutes...</p>
                </div>
            </section>

            <section id="results-panel" class="glass-panel p-6 sm:p-8 text-center hidden">
                <h2 class="font-orbitron text-3xl font-bold text-white mb-6">Success! Your Album is Ready!</h2>
                <p id="result-message" class="text-lg text-gray-300 mb-6"></p>
                <a id="download-button" href="#" class="inline-block btn-primary text-white font-bold py-4 px-8 rounded-lg text-lg">Download Album (ZIP)</a>
                 <button id="create-another" class="mt-4 w-full md:w-auto md:inline-block bg-gray-700 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-600 transition">Create Another</button>
            </section>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const inputPanel = document.getElementById('input-panel');
        const processingPanel = document.getElementById('processing-panel');
        const resultsPanel = document.getElementById('results-panel');
        const audioFileInput = document.getElementById('audio-file-input');
        const fileDropZone = document.getElementById('file-drop-zone');
        const fileLabel = document.getElementById('file-label');
        const albumTitle = document.getElementById('album-title');
        const createAlbumButton = document.getElementById('create-album-button');
        const experienceInputsContainer = document.getElementById('experience-inputs');
        const addExperienceButton = document.getElementById('add-experience');
        const downloadButton = document.getElementById('download-button');
        const resultMessage = document.getElementById('result-message');
        const createAnotherButton = document.getElementById('create-another');
        const processingHeader = document.getElementById('processing-header');
        const processingStatus = document.getElementById('processing-status');
        
        let inputFile = null;
        let pollInterval = null;

        function updateCreateButton() {
            const hasFile = inputFile !== null;
            const hasTitle = albumTitle.value.trim().length > 0;
            const hasExperiences = Array.from(document.querySelectorAll('.experience-input')).some(input => input.value.trim().length > 0);
            createAlbumButton.disabled = !(hasFile && hasTitle && hasExperiences);
        }

        function handleFileSelect(file) {
            if (!file || !file.type.startsWith('audio/')) return;
            inputFile = file;
            fileLabel.textContent = `File: ${file.name}`;
            updateCreateButton();
        }

        function createExperienceInput(placeholder = '') {
            const group = document.createElement('div');
            group.className = 'flex gap-2 items-center';
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'experience-input flex-1 bg-gray-900/50 border border-gray-600 rounded-lg p-3 focus:ring-2 focus:ring-purple-500';
            input.placeholder = placeholder || 'Describe a memory or feeling';
            input.addEventListener('input', updateCreateButton);
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-experience text-gray-400 hover:text-red-400';
            removeBtn.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`;
            removeBtn.onclick = () => {
                group.remove();
                updateCreateButton();
            };
            group.appendChild(input);
            group.appendChild(removeBtn);
            experienceInputsContainer.appendChild(group);
        }
        
        function pollForStatus(jobId) {
            pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/.netlify/functions/status?id=${jobId}`);
                    if (!response.ok) return;
                    const data = await response.json();

                    if (data.status === 'completed') {
                        clearInterval(pollInterval);
                        downloadButton.href = `/.netlify/functions/download?id=${jobId}`;
                        downloadButton.download = data.filename;
                        resultMessage.textContent = `Your album "${data.albumTitle}" is ready to download.`;
                        processingPanel.classList.add('hidden');
                        resultsPanel.classList.remove('hidden');
                    } else if (data.status === 'failed') {
                        clearInterval(pollInterval);
                        processingHeader.textContent = 'An Error Occurred';
                        processingStatus.textContent = data.error || 'Processing failed. Please try again.';
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                    clearInterval(pollInterval);
                }
            }, 5000);
        }

        async function handleSubmit() {
            inputPanel.classList.add('hidden');
            processingPanel.classList.remove('hidden');
            
            try {
                // Step 1: Generate a unique job ID on the client side.
                const jobId = crypto.randomUUID();

                processingHeader.textContent = 'Uploading...';
                processingStatus.textContent = 'Uploading your audio file directly.';

                // Step 2: Upload the file directly to our new upload function.
                const uploadResponse = await fetch('/.netlify/functions/upload', {
                    method: 'POST',
                    headers: {
                        'x-job-id': jobId // Pass the jobId in a custom header
                    },
                    body: inputFile
                });

                if (!uploadResponse.ok) {
                    const err = new Error('Server returned an error during file upload.');
                    err.response = uploadResponse;
                    throw err;
                }

                processingStatus.textContent = 'Starting the album creation process...';
                
                // Step 3: Kick off the background processing job with the same jobId.
                const metadata = {
                    jobId,
                    albumTitle: document.getElementById('album-title').value,
                    recipientName: document.getElementById('recipient-name').value,
                    experiences: Array.from(document.querySelectorAll('.experience-input')).map(input => input.value.trim()).filter(Boolean),
                };

                const processResponse = await fetch('/.netlify/functions/process-audio-background', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(metadata),
                });

                if (!processResponse.ok) {
                    const err = new Error('Server returned an error while starting the process.');
                    err.response = processResponse;
                    throw err;
                }

                processingHeader.textContent = 'Processing Your Album';
                processingStatus.textContent = 'Your album is being created in the background. This may take a few minutes...';
                pollForStatus(jobId);

            } catch (error) {
                console.error('Submission error:', error);
                processingHeader.textContent = 'An Error Occurred';

                if (error && error.response) {
                    const serverErrorBody = await error.response.text();
                    processingStatus.textContent = `Error from server (${error.response.status}): ${serverErrorBody || error.message}`;
                } else if (error) {
                    processingStatus.textContent = `Could not prepare upload. Details: ${error.message}`;
                } else {
                    processingStatus.textContent = 'An unknown error occurred during the submission process.';
                }
            }
        }
        
        function resetUI() {
            if (pollInterval) clearInterval(pollInterval);
            inputPanel.classList.remove('hidden');
            processingPanel.classList.add('hidden');
            resultsPanel.classList.add('hidden');
            inputFile = null;
            audioFileInput.value = '';
            fileLabel.textContent = 'Drop your audio file here, or click to browse';
            albumTitle.value = '';
            document.getElementById('recipient-name').value = '';
            experienceInputsContainer.innerHTML = '';
            createExperienceInput('e.g., Summer nights at the beach');
            createExperienceInput('e.g., First day of school');
            updateCreateButton();
        }

        // Initial Setup
        createExperienceInput('e.g., Summer nights at the beach');
        createExperienceInput('e.g., First day of school');
        [albumTitle, document.getElementById('recipient-name')].forEach(el => el.addEventListener('input', updateCreateButton));
        fileDropZone.addEventListener('click', () => audioFileInput.click());
        audioFileInput.addEventListener('change', (e) => handleFileSelect(e.target.files[0]));
        addExperienceButton.addEventListener('click', () => createExperienceInput());
        createAlbumButton.addEventListener('click', handleSubmit);
        createAnotherButton.addEventListener('click', resetUI);
    });
    </script>
</body>
</html>


